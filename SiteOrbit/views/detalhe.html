{% extends 'base.html' %}

{% block content %}

<head>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/desaparecidos.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
</head>

<section class="detalhe-section py-5">
  <div class="container">
    <button onclick="history.back()" class="btn btn-sm btn-outline-secondary mb-4">← Voltar</button>

    <div class="detalhe-card shadow-lg rounded-4 p-4 bg-white">
      <div class="row g-4 align-items-center">
        <!-- FOTO -->
        <div class="col-md-5 text-center">
          {% if pessoa.imagem %}
          <img src="{{ 'http://localhost/appTcc/uploads/' + pessoa.imagem }}" alt="{{ pessoa.nome }}" class="img-fluid rounded-3 detalhe-img">
          {% else %}
          <div class="img-placeholder detalhe-img"></div>
          {% endif %}
        </div>

        <!-- INFORMAÇÕES (COMO NO INÍCIO) -->
        <div class="col-md-7">
          <h2 class="mb-3 text-primary fw-bold">{{ pessoa.nome }}, {{ pessoa.idade }} anos</h2>
          {% if anunciante %}
          <p class="text-muted mb-2"><strong>Anunciado por:</strong> {{ anunciante }}</p>
          {% endif %}
          <div class="row">
            <div class="col-sm-6">
              <p><strong>Sexo:</strong> {{ pessoa.sexo }}</p>
              <p><strong>Altura:</strong> {{ pessoa.altura }} cm</p>
              <p><strong>Contato:</strong> {{ pessoa.telefoneContato }}</p>
            </div>
            <div class="col-sm-6">
              <p><strong>Último local visto:</strong> {{ pessoa.localVisto }}</p>
              <p><strong>Data e hora:</strong>
                {% if pessoa.vezVisto %}
                {% if pessoa.vezVisto is string %}
                {{ pessoa.vezVisto }}
                {% else %}
                {{ pessoa.vezVisto.strftime('%d/%m/%Y às %H:%M') }}
                {% endif %}
                {% else %}
                Data não informada
                {% endif %}
              </p>
            </div>
          </div>
          <p class="mt-3"><strong>Descrição detalhada:</strong><br>{{ pessoa.descricao }}</p>
          <button type="button" id="btn-open-map" class="btn-view-map mt-2">
            Ver no mapa
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL DO MAPA -->
    <div id="map-modal" class="modal-map" aria-hidden="true">
      <div class="modal-map__dialog">
        <button type="button" class="modal-map__close" id="btn-close-map" aria-label="Fechar">×</button>
        <div id="map" class="map-container"></div>
      </div>
      <div class="modal-map__backdrop" id="map-backdrop"></div>
    </div>

    <div class="comentarios-section mt-5 p-4 rounded-3">
      <h4 class="mb-3">Comentários</h4>
      <form id="comment-form" class="mb-4">
        <div class="mb-3">
          <textarea id="comment" class="form-control" rows="4"
            placeholder="Compartilhe informações que possam ajudar..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Enviar</button>
      </form>
      <div id="comments-list"></div>
    </div>

    <!-- RELACIONADOS -->
    <div class="relacionados-section mt-5">
      <h4 class="mb-4">Outros desaparecidos</h4>
      <div class="row g-4">
        {% for r in relacionados %}
        <div class="col-md-3">
          <div class="card desaparecido-card h-100">
            <img src="{{ 'http://localhost/appTcc/uploads/' + r.imagem }}" class="card-img-top" alt="{{ r.nome }}"
              style="height: 220px; object-fit: cover;">
            <div class="card-body text-center">
              <h6 class="card-title">{{ r.nome }}</h6>
              <a href="{{ url_for('detalhe', id=r.id) }}" class="btn btn-sm btn-outline-primary mt-2">Ver detalhes</a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

<script>
  const form = document.getElementById('comment-form');
  const list = document.getElementById('comments-list');
  form.addEventListener('submit', e => {
    e.preventDefault();
    const txt = document.getElementById('comment').value.trim();
    if (!txt) return;
    const div = document.createElement('div');
    div.className = 'comentario-card';
    div.textContent = "@usuario: " + txt;
    list.prepend(div);
    form.reset();
  });
</script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  (function() {
    const endereco = `{{ pessoa.localVisto|default('') }}`;

    let mapInstance = null;

    function openModal() {
      const modal = document.getElementById('map-modal');
      modal.classList.add('is-open');
      setTimeout(initMapIfNeeded, 150);
    }

    function closeModal() {
      document.getElementById('map-modal').classList.remove('is-open');
    }

    function initMapIfNeeded() {
      if (mapInstance) { mapInstance.invalidateSize(); return; }
      const defaultCenter = [-24.4979, -47.8439];
      mapInstance = L.map('map').setView(defaultCenter, 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(mapInstance);

      if (endereco && endereco.trim() !== '') {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}`)
          .then(res => res.json())
          .then(results => {
            if (results && results.length > 0) {
              const place = results[0];
              const lat = parseFloat(place.lat);
              const lon = parseFloat(place.lon);
              const markerIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41]
              });
              L.marker([lat, lon], { icon: markerIcon }).addTo(mapInstance);
              L.circle([lat, lon], { color: 'red', fillColor: 'red', fillOpacity: 0.2, radius: 100 }).addTo(mapInstance);
              mapInstance.setView([lat, lon], 16);
            }
          });
      }
    }

    // Wire up triggers
    const btnOpen = document.getElementById('btn-open-map');
    const btnClose = document.getElementById('btn-close-map');
    const backdrop = document.getElementById('map-backdrop');
    btnOpen && btnOpen.addEventListener('click', openModal);
    btnClose && btnClose.addEventListener('click', closeModal);
    backdrop && backdrop.addEventListener('click', closeModal);
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
  })();
</script>
{% endblock content %}