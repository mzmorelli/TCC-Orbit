{% extends 'base.html' %}

{% block content %}

<head>
  <link rel="stylesheet" href="static/css/desaparecidos.css">
  <link rel="stylesheet" href="static/css/style.css" />
  <link rel="stylesheet" href="static/css/orbit-modern.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="static/css/map.css">
</head>

<section class="hero-custom">
  <div class="container hero-content">
    <div class="hero-text">
      <h1 class="mb-3"><strong>A vida gira. <br> ORBIT acompanha.</strong></h1>
      <p class="mb-4">Descubra o poder do ORBIT. A solução nº 1 para tornar a vida familiar mais segura e conectada.</p>
      <div class="hero-buttons">
        <a href="#" class="btn-join">
          <i class="fas fa-download me-2"></i>BAIXAR APP
        </a>
        <a href="#desaparecidos" class="btn-secondary">
          <i class="fas fa-users me-2"></i>VER DESAPARECIDOS
        </a>
      </div>
    </div>
    <div class="hero-visual">
      <div class="floating-card">
        <div class="app-screen">
          <img src="../static/imgs/app-preview.png" alt="Visualização do aplicativo ORBIT">
        </div>
      </div>
    </div>
  </div>
</section>

<section id="desaparecidos" class="desaparecidos-destaque py-5">
  <div class="container">
    <div class="section-header">
      <h2>Pessoas Desaparecidas</h2>
      <p>Ajude-nos a localizar estas pessoas. Qualquer informação é valiosa.</p>
    </div>

    <div class="desaparecidos-carousel">
      <button class="carousel-btn prev" aria-label="Anterior">
        <i class="fas fa-chevron-left"></i>
      </button>
      <div class="carousel-viewport" id="desaparecidos-viewport">
        <div class="carousel-track" id="desaparecidos-track"></div>
      </div>
      <button class="carousel-btn next" aria-label="Próximo">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>

    <div class="text-center mt-5">
      <a href="{{ url_for('desaparecidos') }}" class="btn-ver-mais">
        Ver todas as pessoas desaparecidas <i class="fas fa-arrow-right ms-2"></i>
      </a>
    </div>
  </div>
</section>

<section id="mapa-desaparecidos" class="py-5">
  <div class="container">
    <div class="section-header">
      <h2>Mapa de Desaparecidos</h2>
      <p>Veja no mapa os locais reportados como último avistamento.</p>
    </div>
    <div id="map-desaparecidos" class="map-container rounded-4" style="height: 460px;"></div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    (function() {
      const data = JSON.parse('{{ desaparecidos_json|tojson|safe }}');
      const map = L.map('map-desaparecidos').setView([-14.235, -51.9253], 4);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(map);

      const bounds = L.latLngBounds();
      let plotted = 0;
      const markerIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41]
      });

      function imageFor(d) {
        if (!d.imagem) return '/static/img/imagem-nao-disponivel.png';
        if (d.origem === 'site') return `/static/uploads/${d.imagem}`;
        return `http://localhost/apptcc/uploads/${d.imagem}`;
      }

      // Nominatim throttle para evitar rate-limit
      const delayMs = 400; // ~2.5 req/s
      data.forEach((d, idx) => {
        const address = (d.localVisto || '').toString().trim();
        if (!address) return;
        setTimeout(() => {
          fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
            .then(r => r.json())
            .then(results => {
              if (!results || results.length === 0) return;
              const place = results[0];
              const lat = parseFloat(place.lat);
              const lon = parseFloat(place.lon);
              if (isNaN(lat) || isNaN(lon)) return;

              const marker = L.marker([lat, lon], { icon: markerIcon }).addTo(map);
              const popup = `
                <div class="custom-popup">
                  <div class="popup-header">
                    <img class="popup-avatar" src="${imageFor(d)}" onerror="this.style.display='none'"/>
                    <div class="popup-texts">
                      <div class="popup-title">${d.nome}</div>
                      <div class="popup-sub">${(d.localVisto || 'Local não informado')}</div>
                    </div>
                  </div>
                </div>
              `;
              marker.bindPopup(popup);
              bounds.extend([lat, lon]);
              plotted++;
              if (plotted === 1) {
                map.setView([lat, lon], 13);
              } else {
                map.fitBounds(bounds, { padding: [40, 40], maxZoom: 14 });
              }
            })
            .catch(() => {});
        }, idx * delayMs);
      });
    })();
  </script>
</section>

<script>
  (function () {
    const data = JSON.parse('{{ desaparecidos_json|tojson|safe }}');
    const track = document.getElementById('desaparecidos-track');
    const viewport = document.getElementById('desaparecidos-viewport');
    const btnPrev = document.querySelector('.desaparecidos-carousel .prev');
    const btnNext = document.querySelector('.desaparecidos-carousel .next');

    let slidesPerView = 4;
    let currentIndex = 0; // index of the left-most visible slide
    let autoTimer = null;
    let isTransitioning = false;

    function computeSlidesPerView() {
      const w = window.innerWidth;
      if (w < 576) return 1;
      if (w < 992) return 2;
      return 4;
    }

    function slideTemplate(d) {
      const imgHtml = d.imagem
        ? (d.origem === 'site'
            ? `<img src="/static/uploads/${d.imagem}" alt="Foto de ${d.nome}">`
            : `<img src="http://localhost/apptcc/uploads/${d.imagem}" alt="Foto de ${d.nome}">`
          )
        : `<img src="/static/img/imagem-nao-disponivel.png" alt="Imagem não disponível">`;

      return `
        <div class="carousel-slide">
          <div class="flip-card">
            <div class="flip-card-inner">
              <div class="flip-card-front">
                ${imgHtml}
                <div class="card-overlay"></div>
                <div class="overlay-info">
                  <h5>${d.nome}</h5>
                  <p><i class="fas fa-map-marker-alt me-2"></i>${d.localVisto || 'Não informado'}</p>
                  <p><i class="fas fa-clock me-2"></i>${d.vezVisto || 'Não informado'}</p>
                </div>
              </div>
              <div class="flip-card-back">
                <div class="back-content">
                  <h5>Informações</h5>
                  <p class="info-row"><strong><i class="fas fa-phone me-2"></i>Contato:</strong> <span class="text-value">${d.telefoneContato || 'Não informado'}</span></p>
                  <p class="info-row"><strong><i class="fas fa-file-alt me-2"></i>Descrição:</strong> <span class="description-text">${d.descricao || 'Não informado'}</span></p>
                  <p class="info-row"><strong><i class="fas fa-calendar me-2"></i>Visto por último:</strong> <span class="text-value">${d.vezVisto || 'Não informado'}</span></p>
                  <a href="/detalhe/${d.id}" class="btn-detalhes">
                    <i class="fas fa-info-circle me-2"></i>Ver detalhes
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>`;
    }

    // Build initial content with multiple sets to avoid immediate appends
    function buildTrack() {
      slidesPerView = computeSlidesPerView();
      const initialSets = 3; // render 3x data initially
      let html = '';
      for (let s = 0; s < initialSets; s++) {
        html += data.map(d => slideTemplate(d)).join('');
      }
      track.innerHTML = html;
      currentIndex = 0;
      setImmediatePosition();
    }

    function getSlideWidth() {
      const first = track.querySelector('.carousel-slide');
      return first ? first.getBoundingClientRect().width : 0;
    }

    function setImmediatePosition() {
      const w = getSlideWidth();
      track.style.transition = 'none';
      track.style.transform = `translateX(${-currentIndex * w}px)`;
      // force reflow then restore transition
      requestAnimationFrame(() => {
        track.style.transition = '';
      });
    }

    function goTo(index) {
      if (isTransitioning) return;
      isTransitioning = true;
      const w = getSlideWidth();
      track.style.transform = `translateX(${-index * w}px)`;
      currentIndex = index;
    }

    function next() {
      // Append another full set when we are close to the end
      const totalSlides = track.children.length;
      const threshold = totalSlides - (slidesPerView * 2);
      if (currentIndex >= threshold) {
        // append one more set of slides forward-only
        track.insertAdjacentHTML('beforeend', data.map(d => slideTemplate(d)).join(''));
      }
      goTo(currentIndex + slidesPerView);
    }

    function prev() {
      // Forward-only behavior: disable previous navigation
      return;
    }

    function onTransitionEnd() {
      isTransitioning = false;
    }

    function startAuto() {
      stopAuto();
      autoTimer = setInterval(next, 8000);
    }

    function stopAuto() {
      if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
      }
    }

    // Events
    btnNext.addEventListener('click', () => { next(); startAuto(); });
    btnPrev.addEventListener('click', () => { prev(); });
    viewport.addEventListener('mouseenter', stopAuto);
    viewport.addEventListener('mouseleave', startAuto);
    track.addEventListener('transitionend', onTransitionEnd);
    window.addEventListener('resize', () => {
      const oldPerView = slidesPerView;
      const newPerView = computeSlidesPerView();
      if (oldPerView !== newPerView) {
        buildTrack();
      } else {
        setImmediatePosition();
      }
    });

    // Init
    buildTrack();
    startAuto();
  })();
</script>

<section class="features-custom">
  <div class="container">
    <div class="section-header">
      <h2>Por que escolher o ORBIT?</h2>
      <p>Recursos inovadores para manter sua família segura e conectada</p>
    </div>
    <div class="row g-4">
      <div class="col-md-4">
        <div class="feature-card">
          <div class="feature-icon">
            <i class="fas fa-users"></i>
          </div>
          <h3>Acompanhe seus familiares</h3>
          <p>Localização em tempo real e histórico de rotas com atualizações instantâneas</p>
        </div>
      </div>

      <div class="col-md-4">
        <div class="feature-card">
          <div class="feature-icon">
            <i class="fas fa-address-book"></i>
          </div>
          <h3>Denúncias de pessoas desaparecidas</h3>
          <p>Informações detalhadas sobre as vítimas perto de você</p>
        </div>
      </div>

      <div class="col-md-4">
        <div class="feature-card">
          <div class="feature-icon">
            <i class="fas fa-shield-alt"></i>
          </div>
          <h3>Segurança em tempo real</h3>
          <p>Alertas automáticos e monitoramento de deslocamentos seguros</p>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="about-project py-5">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-6">
        <div class="section-header left-aligned">
          <h2>Sobre o Projeto ORBIT</h2>
          <p class="lead">Mais do que um aplicativo, uma rede de segurança</p>
        </div>
        <p>O ORBIT foi desenvolvido com a missão de proporcionar tranquilidade às famílias e ajudar na localização de pessoas desaparecidas.</p>
        <div class="features-list">
          <div class="feature-item">
            <div class="feature-number">01</div>
            <div class="feature-text">
              <h4>Área dedicada a vítimas de desaparecimento</h4>
              <p>Informações centralizadas para ajudar a localizar pessoas desaparecidas</p>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-number">02</div>
            <div class="feature-text">
              <h4>Localização em tempo real de familiares</h4>
              <p>Saiba onde seus entes queridos estão a qualquer momento</p>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-number">03</div>
            <div class="feature-text">
              <h4>Alertas inteligentes de segurança</h4>
              <p>Notificações instantâneas para situações de emergência</p>
            </div>
          </div>
        </div>
        <a href="#" class="btn-about-project">
          Saiba mais sobre o projeto <i class="fas fa-arrow-right ms-2"></i>
        </a>
      </div>
      <div class="col-lg-6">
        <div class="about-visual">
          <div class="main-image">
            <img src="../static/imgs/logo.png" alt="Aplicativo ORBIT em uso">
          </div>
          <div class="floating-element el-1"></div>
          <div class="floating-element el-2"></div>
          <div class="floating-element el-3"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="testimonials py-5">
  <div class="container">
    <div class="section-header">
      <h2>O que nossos usuários dizem</h2>
      <p>Histórias reais de pessoas que confiam no ORBIT</p>
    </div>
    <div class="row">
      <div class="col-md-4">
        <div class="testimonial-card">
          <div class="testimonial-content">
            <div class="quote-icon">
              <i class="fas fa-quote-left"></i>
            </div>
            <p class="testimonial-text">"O Orbit me dá paz sabendo que posso localizar meus filhos rapidamente!"</p>
          </div>
          <div class="testimonial-author">
            <div class="author-avatar">
              <i class="fas fa-user-circle"></i>
            </div>
            <div class="author-info">
              <h5>Carlos Silva</h5>
              <p>Pai de dois adolescentes</p>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="testimonial-card">
          <div class="testimonial-content">
            <div class="quote-icon">
              <i class="fas fa-quote-left"></i>
            </div>
            <p class="testimonial-text">"Junto com o Orbit, eu consegui localizar a minha mãe que havia desaparecido!"</p>
          </div>
          <div class="testimonial-author">
            <div class="author-avatar">
              <i class="fas fa-user-circle"></i>
            </div>
            <div class="author-info">
              <h5>Ana Oliveira</h5>
              <p>Mãe e professora</p>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="testimonial-card">
          <div class="testimonial-content">
            <div class="quote-icon">
              <i class="fas fa-quote-left"></i>
            </div>
            <p class="testimonial-text">"Meus netos me ensinaram a usar e agora me sinto muito mais seguro quando saio sozinho."</p>
          </div>
          <div class="testimonial-author">
            <div class="author-avatar">
              <i class="fas fa-user-circle"></i>
            </div>
            <div class="author-info">
              <h5>Roberto Santos</h5>
              <p>Avô</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% endblock content %}